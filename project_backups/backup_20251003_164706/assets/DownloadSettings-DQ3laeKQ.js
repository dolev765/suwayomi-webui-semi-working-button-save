import{u as j,j as t,H as T,o as b,p as m,by as f,Z as X,m as R,g as E,b as N,aS as K,i as Z,k as J,n as Q,b7 as ee,S as y,q as te,B as L,bz as ae,b2 as $,bA as V,C as oe,I as se,bd as ne,r as M,b4 as le,a as de,e as re,f as U,y as ie}from"./index-B3NSCdsi.js";import{T as ce}from"./TextSetting-Bbq1hKUk.js";import{N as B}from"./NumberSetting-DZ-XTU9n.js";import{u as he,g as ue}from"./usePersistedValue-hjQaLPKk.js";import{S as _}from"./Switch-Ba0YZzPv.js";import{S as pe}from"./SelectSetting-DYiz4PGL.js";import{a as ge}from"./CategoriesInclusionSetting-DEtPwuyO.js";import{E as me}from"./EmptyViewAbsoluteCentered-DBqm8ISe.js";import{u as we}from"./useAppTitle-CiigzFb7.js";import{D as xe}from"./Delete-CRgzWPPc.js";import{L as P}from"./ListSubheader-Ddg_DhEe.js";import"./Slider-CwwfJui_.js";import"./SwitchBase-CZLmNsA7.js";import"./Select-CbmmqdPd.js";import"./ThreeStateCheckboxInput-tKUmVeuL.js";import"./Checkbox-D6x2ifd_.js";const be=({downloadAheadLimit:e})=>{const{t:a}=j(),s=!!e,[n,h]=he("lastDownloadAheadLimit",f.default,e,ue),d=r=>{h(r===0?n:r),X("downloadAheadLimit",r).catch(p=>R(a("global.error.label.failed_to_save_changes"),"error",E(p)))},i=r=>{d(r?n:0)};return t.jsxs(T,{children:[t.jsxs(b,{children:[t.jsx(m,{primary:a("download.settings.download_ahead.label.while_reading")}),t.jsx(_,{edge:"end",checked:s,onChange:r=>i(r.target.checked)})]}),t.jsx(B,{settingTitle:a("download.settings.download_ahead.label.unread_chapters_to_download"),settingValue:a("download.settings.download_ahead.label.value",{chapters:n,count:n}),value:n,minValue:f.min,maxValue:f.max,defaultValue:f.default,stepSize:f.step,showSlider:!0,dialogDescription:a("download.settings.download_ahead.label.description"),dialogDisclaimer:a("download.settings.download_ahead.label.disclaimer"),valueUnit:a("chapter.title_one"),handleUpdate:d,disabled:!s})]})},_e=[0,1,2,3,4,5],Ce={0:{text:"global.label.disabled"},1:{text:"download.settings.delete_chapters.while_reading.option.label.first"},2:{text:"download.settings.delete_chapters.while_reading.option.label.second"},3:{text:"download.settings.delete_chapters.while_reading.option.label.third"},4:{text:"download.settings.delete_chapters.while_reading.option.label.fourth"},5:{text:"download.settings.delete_chapters.while_reading.option.label.fifth"}},je=_e.map(e=>[e,Ce[e]]),De=e=>typeof e=="boolean"?Number(e):e,fe=({chapterToDelete:e,handleChange:a})=>{const{t:s}=j(),n=De(e);return t.jsx(pe,{settingName:s("download.settings.delete_chapters.while_reading.label.title"),value:n,values:je,handleChange:a})},H="default",A="image/",F=-1,v=e=>e.replace(A,""),G=e=>v(e.toLowerCase().trim())===H,q=(e,a,s)=>s.slice(0,a).some(n=>n.mimeType===e),Y=e=>e==null||e>=V.min&&e<=V.max,Te=e=>e.some(({mimeType:a,compressionLevel:s},n)=>!Y(s)||q(a,n,e)),O=e=>e.map(a=>({...a,mimeType:v(a.mimeType),target:v(a.target)})),W=e=>e.filter(({mimeType:a,target:s})=>!!a&&!!s).map(a=>({...a,mimeType:"".concat(A).concat(a.mimeType),target:"".concat(A).concat(a.target)})),S=e=>[...e.some(({mimeType:s})=>G(s))?[]:[{mimeType:H,target:"",compressionLevel:null}],...e],ye=(e,a)=>e.length!==a.length?!0:e.some(({mimeType:s,target:n,compressionLevel:h},d)=>{const i=a[d];return v(s)!==i.mimeType||v(n)!==i.target||h!==i.compressionLevel}),z=({shouldAutoFocus:e,isDefault:a,isDuplicate:s,label:n,value:h,onUpdate:d})=>{const{t:i}=j();return t.jsx($,{sx:{maxWidth:150},autoFocus:e,label:n,value:h,disabled:a,error:s,helperText:s&&i("global.error.label.invalid_input"),slotProps:{input:{startAdornment:t.jsx(ne,{position:"start",children:A})}},onChange:r=>d(r.target.value.trim())})},ve=({shouldAutoFocusMimeTypeTextField:e,conversion:{mimeType:a,target:s,compressionLevel:n},setFocusMimeTypeTextField:h,onChange:d,isDuplicate:i})=>{const{t:r}=j(),p=Y(n),w=G(a)&&!i,o=w&&!s&&n==null;return t.jsxs(y,{sx:{gap:1,flexDirection:"row",flexWrap:"nowrap",alignItems:"center",pt:1},children:[t.jsxs(y,{sx:{gap:1,flexDirection:"row",alignItems:"baseline",flexWrap:"wrap"},children:[t.jsx(z,{shouldAutoFocus:e,isDefault:w,isDuplicate:i,label:r("download.settings.conversion.mime_type"),value:a,onUpdate:c=>{h(!0),d({mimeType:c,target:s,compressionLevel:n})}}),t.jsx(ae,{sx:{mx:1},children:"→"}),t.jsx(z,{shouldAutoFocus:!1,isDefault:!1,isDuplicate:!1,label:r("download.settings.conversion.target"),value:s,onUpdate:c=>d({mimeType:a,target:c,compressionLevel:n})}),t.jsx($,{label:r("download.settings.conversion.compression_level"),value:n!=null?n:"",type:"number",error:!p,helperText:p?"":r("global.error.label.invalid_input"),slotProps:{input:{inputProps:V}},onChange:c=>{d({mimeType:a,target:s,compressionLevel:c.target.value?Number(c.target.value):void 0})}})]}),t.jsx(oe,{disabled:o,title:r("chapter.action.download.delete.label.action"),children:t.jsx(se,{disabled:o,onClick:()=>{h(!1),d(null)},children:t.jsx(xe,{})})})]})},Se=({conversions:e,updateSetting:a})=>{const{t:s}=j(),[n,h]=N.useState(!1),[d,i]=N.useState(O(S(e))),[r,p]=N.useState(F),w=Te(d),o=ye(O(S(e)),d),c=(u=e)=>{i(O(S(u))),h(!1)},C=()=>{c(e)};return t.jsxs(t.Fragment,{children:[t.jsx(K,{disabled:!1,onClick:()=>h(!0),children:t.jsx(m,{primary:s("download.settings.conversion.title"),secondary:e.map(u=>"".concat(u.mimeType," → ").concat(u.target)).join("; "),secondaryTypographyProps:{style:{display:"flex",flexDirection:"column"}}})}),t.jsxs(Z,{open:n,onClose:C,children:[t.jsx(J,{children:s("download.settings.conversion.title")}),t.jsxs(Q,{children:[t.jsx(ee,{sx:{mb:2,whiteSpace:"pre-line"},children:s("download.settings.conversion.description",{value:"none"})}),t.jsx(y,{sx:{flexDirection:"column",gap:3},children:d.map((u,g)=>{const{mimeType:D}=u,l=q(D,g,d),k=g===r;return t.jsx(ve,{conversion:u,isDuplicate:l,setFocusMimeTypeTextField:x=>p(x?g:F),shouldAutoFocusMimeTypeTextField:k,onChange:x=>{i(I=>S(I.toSpliced(g,1,...x?[x]:[])))}},"".concat(D,"-").concat(g))})})]}),t.jsx(te,{children:t.jsxs(y,{direction:"row",sx:{justifyContent:"space-between",width:"100%"},children:[t.jsx(L,{variant:"outlined",onClick:()=>{i(u=>[...u,{mimeType:"",target:"",compressionLevel:null}])},children:s("global.button.add")}),t.jsxs(y,{direction:"row",children:[t.jsx(L,{onClick:C,children:s("global.button.cancel")}),t.jsx(L,{disabled:w||!o,onClick:()=>a(W(d)).then(()=>c(W(d))),children:s("global.button.ok")})]})]})})]})]})},Ee=e=>({downloadAsCbz:e.downloadAsCbz,downloadsPath:e.downloadsPath,autoDownloadNewChapters:e.autoDownloadNewChapters,autoDownloadNewChaptersLimit:e.autoDownloadNewChaptersLimit,excludeEntryWithUnreadChapters:e.excludeEntryWithUnreadChapters,autoDownloadIgnoreReUploads:e.autoDownloadIgnoreReUploads,downloadConversions:e.downloadConversions}),He=()=>{var u,g,D;const{t:e}=j();we(e("download.title.download"));const a=M.useGetCategories(le),s=M.useGetServerSettings({notifyOnNetworkStatusChange:!0}),[n]=M.useUpdateServerSettings(),{settings:h,loading:d,request:{error:i,refetch:r}}=de();if(s.loading||d||a.loading)return t.jsx(re,{});const w=(g=(u=s.error)!=null?u:i)!=null?g:a.error;if(w)return t.jsx(me,{message:e("global.error.label.failed_to_load_data"),messageExtra:E(w),retry:()=>{s.error&&s.refetch().catch(U()),i&&r().catch(U()),a.error&&a.refetch().catch(U())}});const o=Ee(s.data.settings),c=(l,k)=>{const x=n({variables:{input:{settings:{[l]:k}}}});return x.catch(I=>R(e("global.error.label.failed_to_save_changes"),"error",E(I))),x},C=ie(l=>R(e("global.error.label.failed_to_save_changes"),"error",E(l)));return t.jsxs(T,{sx:{pt:0},children:[t.jsx(ce,{settingName:e("download.settings.download_path.label.title"),dialogDescription:e("download.settings.download_path.label.description"),value:o==null?void 0:o.downloadsPath,settingDescription:o!=null&&o.downloadsPath.length?o.downloadsPath:e("global.label.default"),handleChange:l=>c("downloadsPath",l)}),t.jsxs(b,{children:[t.jsx(m,{primary:e("download.settings.file_type.label.cbz")}),t.jsx(_,{edge:"end",checked:!!(o!=null&&o.downloadAsCbz),onChange:l=>c("downloadAsCbz",l.target.checked)})]}),t.jsx(Se,{conversions:o==null?void 0:o.downloadConversions,updateSetting:l=>c("downloadConversions",l)}),t.jsxs(T,{subheader:t.jsx(P,{component:"div",id:"download-settings-auto-delete-downloads",children:e("download.settings.delete_chapters.title")}),children:[t.jsxs(b,{children:[t.jsx(m,{primary:e("download.settings.delete_chapters.label.manually_marked_as_read")}),t.jsx(_,{edge:"end",checked:h.deleteChaptersManuallyMarkedRead,onChange:l=>C("deleteChaptersManuallyMarkedRead",l.target.checked)})]}),t.jsx(fe,{chapterToDelete:h.deleteChaptersWhileReading,handleChange:l=>C("deleteChaptersWhileReading",l)}),t.jsxs(b,{children:[t.jsx(m,{primary:e("download.settings.delete_chapters.label.allow_deletion_of_bookmarked")}),t.jsx(_,{edge:"end",checked:h.deleteChaptersWithBookmark,onChange:l=>C("deleteChaptersWithBookmark",l.target.checked)})]})]}),t.jsxs(T,{subheader:t.jsx(P,{component:"div",id:"download-settings-auto-download",children:e("download.settings.auto_download.title")}),children:[t.jsxs(b,{children:[t.jsx(m,{primary:e("download.settings.auto_download.label.new_chapters")}),t.jsx(_,{edge:"end",checked:!!(o!=null&&o.autoDownloadNewChapters),onChange:l=>c("autoDownloadNewChapters",l.target.checked)})]}),t.jsx(B,{disabled:!(o!=null&&o.autoDownloadNewChapters),settingTitle:e("download.settings.auto_download.download_limit.label.title"),dialogDescription:e("download.settings.auto_download.download_limit.label.description"),value:(D=o==null?void 0:o.autoDownloadNewChaptersLimit)!=null?D:0,settingValue:o.autoDownloadNewChaptersLimit?e("download.settings.download_ahead.label.value",{chapters:o.autoDownloadNewChaptersLimit,count:o.autoDownloadNewChaptersLimit}):e("global.label.none"),defaultValue:0,minValue:0,maxValue:20,showSlider:!0,valueUnit:e("chapter.title_one"),handleUpdate:l=>c("autoDownloadNewChaptersLimit",l)}),t.jsxs(b,{children:[t.jsx(m,{primary:e("download.settings.auto_download.label.ignore_with_unread_chapters")}),t.jsx(_,{edge:"end",checked:!!(o!=null&&o.excludeEntryWithUnreadChapters),onChange:l=>c("excludeEntryWithUnreadChapters",l.target.checked),disabled:!(o!=null&&o.autoDownloadNewChapters)})]}),t.jsxs(b,{children:[t.jsx(m,{primary:e("download.settings.auto_download.label.ignore_re_uploads")}),t.jsx(_,{edge:"end",checked:!!(o!=null&&o.autoDownloadIgnoreReUploads),onChange:l=>c("autoDownloadIgnoreReUploads",l.target.checked),disabled:!(o!=null&&o.autoDownloadNewChapters)})]}),t.jsx(ge,{categories:a.data.categories.nodes,includeField:"includeInDownload",dialogText:e("download.settings.auto_download.categories.label.include_in_download")})]}),t.jsx(T,{subheader:t.jsx(P,{component:"div",id:"download-settings-download-ahead",children:e("download.settings.download_ahead.title")}),children:t.jsx(be,{downloadAheadLimit:h.downloadAheadLimit})})]})};export{He as DownloadSettings};
