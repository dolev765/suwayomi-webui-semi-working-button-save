import{c as ee,j as e,u as I,A as R,L as F,r as L,S as X,T as b,l as Ce,B as P,C as O,I as U,m as w,g as A,a as te,b as l,D as Oe,d as Ue,e as se,f as B,t as z,h as he,i as Me,k as Re,n as Pe,o as Be,p as De,q as Ge,s as Fe,v as Ee,w as be,x as ve,y as Te,z as me,E as He,F as ze,G as Ve,H as Ke,J as ge,K as xe,M as qe,N as y}from"./index-B3NSCdsi.js";import{P as Xe}from"./PushPin-BYiJCMYK.js";import{P as We}from"./PushPinOutlined-C-SjmUwh.js";import{SourceContentType as fe}from"./SourceMangas-tzahSfV9.js";import{M as Z}from"./MUI.util-CEodEA2f.js";import{u as $e,S as k,c as Ye}from"./Sources-BeCW7qIA.js";import{L as ne}from"./ListCardAvatar-CIB52Ny-.js";import{L as oe}from"./ListCardContent-BS1h8d31.js";import{C as re}from"./Card-CmqD9oyv.js";import{C as ae}from"./CardActionArea-Ggl6ojvp.js";import{E as q}from"./EmptyViewAbsoluteCentered-DBqm8ISe.js";import{i as Qe,t as W,g as V,I as Je,a as Ze,E as Le,b as G,c as et,u as tt,d as st,e as nt,f as ot,h as rt,j as at,k as it}from"./Extensions.utils-D5qQBtAa.js";import{u as Ie}from"./useAppAction-B9eFgfiP.js";import{S as _e,a as ye}from"./StyledGroupHeader-CdFz2pZf.js";import{V as we}from"./Virtuoso.util-B9xnGAMQ.js";import{S as ie}from"./StyledGroupItemWrapper-lcO4tKwz.js";import{S as ct}from"./SourceLanguageSelect-BsK63fxe.js";import{f as lt}from"./file-selector-DlHkLoY8.js";import{A as ut}from"./Add-D_hggg0n.js";import{A as dt}from"./AppbarSearch-sJLMXTv1.js";import{F as pt}from"./FilterList-CYp6tALP.js";import{q as ht}from"./index-BrsGsN69.js";import{S as mt}from"./Switch-Ba0YZzPv.js";import{u as Se}from"./use-window-event-quZycebx.js";import{T as J,a as K}from"./Tabs-DTRAAzXi.js";import{T as gt}from"./TabsWrapper-lVZiMNsa.js";import{T as xt}from"./TabsMenu-Dyub9C3h.js";import{A as ft,a as St}from"./SortRadioInput-DwArgo8A.js";import{C as jt}from"./Chip-BF4pkKVE.js";import{u as Ct}from"./useAppTitle-CiigzFb7.js";import{G as Et}from"./Virtuoso.constants-DKNufsdf.js";import"./Favorite-Bd4PFCwq.js";import"./GridLayouts-CYKUUf0i.js";import"./Checkbox-D6x2ifd_.js";import"./SwitchBase-CZLmNsA7.js";import"./ListPreference-BJcyAgN-.js";import"./FormGroup-CBmCwp4o.js";import"./Delete-CRgzWPPc.js";import"./CheckboxInput-Dh0Qp3DA.js";import"./ExpandMore-Jy0XmMrp.js";import"./useDebounce-BIAvbtx4.js";import"./ThreeStateCheckboxInput-tKUmVeuL.js";import"./StyledFab-DBXPzirh.js";import"./BaseMangaGrid-CK9pPjn0.js";import"./MangaGrid-C0rwdGG0.js";import"./useManageMangaLibraryState-BUwOAIwu.js";import"./Download-CPjWlyL3.js";import"./ChaptersDownloadActionMenuItems-CcsnGrPF.js";import"./Trackers-Bgo8y--2.js";import"./AvatarSpinner-DZhm5L23.js";import"./CheckCircle-4LYvLq7E.js";import"./Metadata-FLylicix.js";import"./Link-BvpaqdUk.js";import"./NumberSetting-DZ-XTU9n.js";import"./Slider-CwwfJui_.js";import"./useMobilePicker-D4yHrKRj.js";import"./SelectSetting-DYiz4PGL.js";import"./Select-CbmmqdPd.js";import"./Sync-0GqVgN_I.js";import"./use-merged-ref-Box3cAY6.js";import"./PlayArrow-DOQGdp59.js";import"./useAppTitleAndAction-d39yNVev.js";import"./ListItemAvatar-DtAV0KkI.js";const bt=ee(e.jsx("path",{d:"M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5S11 12 11 14.5s2 4.5 4.5 4.5c.9 0 1.7-.3 2.4-.7l3.2 3.2 1.4-1.4zm-3.8.1c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5M12 20v2C6.48 22 2 17.52 2 12S6.48 2 12 2c4.84 0 8.87 3.44 9.8 8h-2.07c-.64-2.46-2.4-4.47-4.73-5.41V5c0 1.1-.9 2-2 2h-2v2c0 .55-.45 1-1 1H8v2h2v3H9l-4.79-4.79C4.08 10.79 4 11.38 4 12c0 4.41 3.59 8 8 8"})),vt=u=>{const{t}=I(),{source:n,showSourceRepo:p,showLanguage:c}=u,{id:s,name:o,lang:r,iconUrl:h,supportsLatest:j,isNsfw:i,extension:{repo:g}}=n,{isPinned:d}=$e(n),x=k.isLocalSource(n)?t("source.local_source.title"):o,f=Ye(n,E=>w(t("global.error.label.failed_to_save_changes"),"error",A(E)));return e.jsx(re,{children:e.jsx(ae,{component:F,to:R.sources.childRoutes.browse.path(s),state:{contentType:fe.POPULAR,clearCache:!0},children:e.jsxs(oe,{children:[e.jsx(ne,{iconUrl:L.getValidImgUrlFor(h),alt:x}),e.jsxs(X,{sx:{justifyContent:"center",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(b,{variant:"h6",component:"h3",children:x}),e.jsxs(b,{variant:"caption",children:[c&&Ce(r),i&&e.jsx(b,{variant:"caption",color:"error",children:" 18+"})]}),p&&e.jsx(b,{variant:"caption",children:g})]}),j&&e.jsx(P,{...Z.preventRippleProp(),variant:"outlined",component:F,to:R.sources.childRoutes.browse.path(s),state:{contentType:fe.LATEST,clearCache:!0},children:t("global.button.latest")}),e.jsx(O,{title:t(d?"source.pin.remove":"source.pin.add"),children:e.jsx(U,{...Z.preventRippleProp(),onClick:E=>{E.preventDefault(),f("isPinned",!d)},color:d?"primary":"inherit",children:d?e.jsx(Xe,{}):e.jsx(We,{})})})]})})})};function je({tabsMenuHeight:u}){const{t}=I(),{languages:n,setLanguages:p}=k.useLanguages(),{settings:{showNsfw:c,lastUsedSourceId:s}}=te(),{data:o,loading:r,error:h,refetch:j}=L.useGetSourceList({notifyOnNetworkStatusChange:!0}),i=o==null?void 0:o.sources.nodes,g=l.useMemo(()=>k.filter(i!=null?i:[],{showNsfw:c,languages:n,keepLocalSource:!0,enabled:!0}),[i,n]),d=l.useMemo(()=>{const m=k.getLastUsedSource(s,g),S=Object.entries(k.groupByLanguage(g));return m?[[Oe.LAST_USED_SOURCE,[m]],...S]:S},[g]),x=l.useMemo(()=>k.getLanguages(i!=null?i:[]),[i]),f=l.useMemo(()=>k.areFromMultipleRepos(g),[g]),E=l.useMemo(()=>d.map(([,m])=>m).flat(1),[d]),T=l.useMemo(()=>d.map(m=>m[1].length),[d]),_=we.useCreateGroupedComputeItemKey(T,l.useCallback(m=>d[m][0],[d]),l.useCallback((m,S)=>"".concat(d[S][0],"_").concat(E[m].id),[E])),M=Ue();return Ie(e.jsxs(e.Fragment,{children:[e.jsx(O,{title:t("search.title.global_search"),children:e.jsx(U,{onClick:()=>M(R.sources.childRoutes.searchAll.path()),color:"inherit",children:e.jsx(bt,{})})}),e.jsx(ct,{selectedLanguages:n,setSelectedLanguages:p,languages:x,sources:i!=null?i:[]})]}),[t,n,x,i]),r?e.jsx(se,{}):h?e.jsx(q,{message:t("global.error.label.failed_to_load_data"),messageExtra:A(h),retry:()=>j().catch(B())}):(i==null?void 0:i.length)===0?e.jsx(q,{message:t("source.error.label.no_sources_found")}):e.jsx(_e,{persistKey:"sources",heightToSubtract:u,overscan:window.innerHeight*.5,groupCounts:T,computeItemKey:_,groupContent:m=>{const[S]=d[m];return e.jsx(ye,{isFirstItem:!m,children:e.jsx(b,{variant:"h5",component:"h2",children:W(S)})})},itemContent:(m,S)=>{const D=d[S][0],C=E[m];return e.jsx(ie,{children:e.jsx(vt,{source:C,showSourceRepo:f,showLanguage:Qe(D)})})}})}function Tt(u){const{t}=I(),{selectedLanguages:n,setSelectedLanguages:p,languages:c}=u,[s,o]=l.useState(z(n)),[r,h]=l.useState(!1),j=l.useMemo(()=>z([...s.toSorted(he),...c.toSorted(he)]),[c,s]),i=()=>{h(!1),o(z(n))},g=()=>{h(!1),p(z(s))},d=(x,f)=>{o(f?[...s,x]:s.toSpliced(s.indexOf(x),1))};return e.jsxs(e.Fragment,{children:[e.jsx(O,{title:t("settings.title"),children:e.jsx(U,{onClick:()=>h(!0),"aria-label":"display more actions",edge:"end",color:"inherit",children:e.jsx(pt,{})})}),e.jsxs(Me,{fullWidth:!0,maxWidth:"xs",open:r,onClose:i,children:[e.jsx(Re,{children:t("global.language.title.enabled_languages")}),e.jsx(Pe,{dividers:!0,sx:{padding:0},children:e.jsx(ht,{style:{height:j.length*54,minHeight:"25vh",maxHeight:"50vh"},data:j,increaseViewportBy:400,computeItemKey:x=>j[x],itemContent:(x,f)=>e.jsxs(Be,{children:[e.jsx(De,{primary:W(f)}),e.jsx(mt,{checked:s.includes(f),onChange:E=>d(f,E.target.checked)})]})})}),e.jsxs(Ge,{children:[e.jsx(P,{autoFocus:!0,onClick:i,color:"primary",children:t("global.button.cancel")}),e.jsx(P,{onClick:g,color:"primary",children:t("global.button.ok")})]})]})]})}const Lt=({disabled:u,children:t,...n})=>u?t:e.jsx(ae,{component:F,...n,children:t});function It(u){const{t}=I(),{extension:{name:n,lang:p,versionName:c,isInstalled:s,hasUpdate:o,isObsolete:r,pkgName:h,iconUrl:j,isNsfw:i,repo:g},handleUpdate:d,showSourceRepo:x,forcedState:f}=u,[E,T]=l.useState(V(s,r,o)),_=f!=null?f:E;l.useEffect(()=>{T(V(s,r,o))},[V(s,r,o)]);const M=async S=>{const D=st[S],C=et[S];try{T(C),await tt(h,r,S),T(D),d()}catch($){T(V(s,r,o))}};function m(){switch(_){case G.INSTALL:case G.UPDATE:case G.UNINSTALL:M(_).catch(B());break;case Le.OBSOLETE:M(G.UNINSTALL).catch(B());break}}return e.jsx(re,{children:e.jsx(Lt,{disabled:!s,to:R.extension.childRoutes.info.path(h),children:e.jsxs(oe,{children:[e.jsx(ne,{iconUrl:L.getValidImgUrlFor(j),alt:n}),e.jsxs(X,{sx:{justifyContent:"center",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(b,{variant:"h6",component:"h3",children:n}),e.jsxs(b,{variant:"caption",children:[s?"".concat(Ce(p)," "):"",c,i&&e.jsx(b,{variant:"caption",color:"error",children:" 18+"})]}),x&&e.jsx(b,{variant:"caption",children:g})]}),s&&e.jsx(O,{title:t("settings.title"),children:e.jsx(U,{color:"inherit",...Z.preventRippleProp(),children:e.jsx(Fe,{})})}),e.jsx(P,{variant:"outlined",sx:{color:_===Ze.OBSOLETE?"red":"inherit",flexShrink:0},onClick:S=>{S.preventDefault(),m()},children:t(Je[_])})]})})})}const _t=0,yt=1,wt=({groupName:u,isFirstItem:t,groupExtensionIds:n,isUpdateGroup:p,updatingExtensionIds:c,setUpdatingExtensionIds:s,handleExtensionUpdate:o})=>{const{t:r}=I();return e.jsxs(ye,{isFirstItem:t,sx:{flexDirection:"row",justifyContent:"space-between",alignItems:"center",pr:1},children:[e.jsx(b,{variant:"h5",component:"h2",children:W(u)}),p&&e.jsx(P,{disabled:!!c.length,variant:"contained",onClick:()=>{s(n),L.updateExtensions(n,{update:!0}).response.then(()=>o()).catch(h=>w(r(it[G.UPDATE],{count:n.length}),"error",A(h))).finally(()=>s([]))},children:r("extension.action.label.update_all")})]},u)};function At({tabsMenuHeight:u}){var de,pe;const{t}=I(),{data:n,loading:p,error:c,refetch:s}=L.useGetServerSettings({notifyOnNetworkStatusChange:!0}),[o,{data:r,loading:h,error:j}]=L.useExtensionListFetch(),{settings:{extensionLanguages:i,showNsfw:g}}=te(),d=Te(a=>w(t("global.error.label.failed_to_save_changes"),"error",A(a))),[x]=Ee(ve.QUERY,be),[f,E]=l.useState([]),[T,_]=l.useState({}),M=p||h,m=c!=null?c:j,S=!!(n!=null&&n.settings.extensionRepos.length),D=((de=n==null?void 0:n.settings.extensionRepos.length)!=null?de:0)>1,C=(pe=r==null?void 0:r.fetchExtensions)==null?void 0:pe.extensions,$=l.useMemo(()=>nt(C!=null?C:[]),[C]),ce=l.useMemo(()=>ot(C!=null?C:[],{selectedLanguages:i,showNsfw:g,query:x}),[C,i,g,x]),N=l.useMemo(()=>rt(ce),[ce]),le=l.useMemo(()=>N.map(a=>a[yt].length),[N]),Y=l.useMemo(()=>N.map(([,a])=>a).flat(1),[N]),Ae=we.useCreateGroupedComputeItemKey(le,l.useCallback(a=>N[a][_t],[N]),l.useCallback(a=>Y[a].pkgName,[Y])),Q=l.useCallback(()=>_({}),[]),ue=a=>{if(!a.name.toLowerCase().endsWith("apk")){w(t("global.error.label.invalid_file_type"),"error");return}w(t("extension.label.installing_file"),"info"),L.installExternalExtension(a).response.then(()=>{Q(),w(t("extension.label.installed_successfully"),"success")}).catch(v=>w(t("extension.label.installation_failed"),"error",A(v)))};return l.useEffect(()=>{o()},[T]),Ie(e.jsxs(e.Fragment,{children:[e.jsx(dt,{}),e.jsx(O,{title:t("extension.action.label.install_external"),children:e.jsx(U,{onClick:()=>{const a=document.createElement("input");a.style.display="none",a.type="file",a.onchange=()=>{var H;const v=(H=a.files)==null?void 0:H[0];v&&ue(v)},document.documentElement.appendChild(a),a.click(),document.documentElement.removeChild(a)},color:"inherit",children:e.jsx(ut,{})})}),e.jsx(Tt,{selectedLanguages:i,setSelectedLanguages:a=>d("extensionLanguages",a),languages:$})]}),[t,i,$]),Se("drop",async a=>{a.preventDefault();const v=await lt(a);ue(v[0])}),Se("dragover",a=>{a.preventDefault()}),M?e.jsx(se,{}):m?e.jsx(q,{message:t("global.error.label.failed_to_load_data"),messageExtra:A(m),retry:()=>{c&&s().catch(B()),j&&o().catch(B())}}):!(C!=null&&C.length)&&!S?e.jsxs(X,{sx:{alignItems:"center",justifyContent:"center",rowGap:"10px",paddingTop:"20px"},children:[e.jsx(b,{children:t("extension.label.add_repository_info")}),e.jsx(P,{component:F,variant:"contained",to:R.settings.childRoutes.browse.path,children:t("settings.title")})]}):e.jsx(_e,{persistKey:"extensions",heightToSubtract:u,overscan:window.innerHeight*.5,groupCounts:le,groupContent:a=>{const[v,H]=N[a],Ne=v===at.UPDATE_PENDING;return e.jsx(wt,{groupName:v,isFirstItem:a===0,groupExtensionIds:H.map(ke=>ke.pkgName),isUpdateGroup:Ne,updatingExtensionIds:f,setUpdatingExtensionIds:E,handleExtensionUpdate:Q})},computeItemKey:Ae,itemContent:a=>{const v=Y[a];return e.jsx(ie,{children:e.jsx(It,{extension:v,handleUpdate:Q,showSourceRepo:D,forcedState:f.includes(v.pkgName)?Le.UPDATING:void 0})})}})}const Nt=ee(e.jsx("path",{d:"M14.94 4.66h-4.72l2.36-2.36zm-4.69 14.71h4.66l-2.33 2.33zM6.1 6.27 1.6 17.73h1.84l.92-2.45h5.11l.92 2.45h1.84L7.74 6.27zm-1.13 7.37 1.94-5.18 1.94 5.18zm10.76 2.5h6.12v1.59h-8.53v-1.29l5.92-8.56h-5.88v-1.6h8.3v1.26z"})),kt=ee(e.jsx("path",{d:"M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"})),Ot=({id:u,name:t,lang:n,iconUrl:p,mangaCount:c})=>{const{t:s}=I(),r=Number(u)===0?s("source.local_source.title"):t;return e.jsx(re,{children:e.jsx(ae,{component:F,to:R.migrate.path(u),children:e.jsxs(oe,{sx:{justifyContent:"space-between"},children:[e.jsxs(me,{sx:{display:"flex",gap:1},children:[e.jsx(ne,{iconUrl:L.getValidImgUrlFor(p),alt:r}),e.jsxs(me,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(b,{variant:"h6",component:"h3",children:r}),e.jsx(b,{variant:"caption",sx:{display:"block"},children:W(n)})]})]}),e.jsx(jt,{sx:{borderRadius:1},size:"small",label:c})]})})})},Ut=(u,{sortBy:t,sortOrder:n})=>{if(!u)return[];const p={};u.forEach(({sourceId:s,source:o})=>{var h;const r=(h=p[s])!=null?h:{id:s,name:s,lang:"unknown",iconUrl:null,mangaCount:0,...o};p[s]={...r,mangaCount:r.mangaCount+1}});const c=Object.values(p).toSorted((s,o)=>{switch(t){case ge.SOURCE_NAME:return s.name.localeCompare(o.name);case ge.MANGA_COUNT:return s.mangaCount-o.mangaCount;default:throw new Error('Unexpected "sortBy" "'.concat(t,'"'))}});switch(n){case xe.ASC:return c;case xe.DESC:return c.toReversed();default:throw new Error('Unexpected "sortOrder" "'.concat(n,'"'))}},Mt=({tabsMenuHeight:u})=>{const{t}=I(),{appBarHeight:n}=He(),{settings:{migrateSortSettings:p}}=te(),c=Te(d=>w(t("global.error.label.failed_to_save_changes"),"error",A(d))),{sortBy:s,sortOrder:o}=p,{data:r,loading:h,error:j,refetch:i}=L.useGetMigratableSources({notifyOnNetworkStatusChange:!0}),g=l.useMemo(()=>Ut(r==null?void 0:r.mangas.nodes,p),[r==null?void 0:r.mangas.nodes,p]);return h?e.jsx(se,{}):j?e.jsx(q,{message:t("global.error.label.failed_to_load_data"),messageExtra:A(j),retry:()=>i().catch(B())}):e.jsxs(e.Fragment,{children:[e.jsxs(X,{sx:{position:"sticky",top:"".concat(n+u,"px"),flexDirection:"row",justifyContent:"end",alignItems:"center",gap:1,p:1,backgroundColor:"background.default",zIndex:1},children:[e.jsx(O,{title:t(ze[s]),children:e.jsx(U,{color:"inherit",onClick:()=>c("migrateSortSettings",{sortBy:(s+1)%2,sortOrder:o}),children:s?e.jsx(kt,{}):e.jsx(Nt,{})})}),e.jsx(O,{title:t(Ve[o]),children:e.jsx(U,{color:"inherit",onClick:()=>c("migrateSortSettings",{sortBy:s,sortOrder:(o+1)%2}),children:o?e.jsx(ft,{}):e.jsx(St,{})})})]}),e.jsx(Ke,{sx:{p:0},children:g.map(d=>e.jsx(ie,{children:e.jsx(Ot,{...d})},d.id))})]})};function qs(){const{t:u}=I();Ct(u("global.label.browse"));const t=l.useRef(null),[n,p]=l.useState(0);qe(t,l.useCallback(()=>p(t.current.offsetHeight),[t.current]));const[c,s]=Ee(ve.TAB,be,{}),o=c!=null?c:y.SOURCES;return c||s(o,"replaceIn"),e.jsxs(gt,{children:[e.jsxs(xt,{ref:t,sx:{zIndex:Et},variant:"fullWidth",value:o,onChange:(r,h)=>s(h,"replaceIn"),children:[e.jsx(J,{value:y.SOURCES,sx:{textTransform:"none"},label:u("source.title_other")}),e.jsx(J,{value:y.EXTENSIONS,sx:{textTransform:"none"},label:u("extension.title_other")}),e.jsx(J,{value:y.MIGRATE,sx:{textTransform:"none"},label:u("migrate.title")})]}),e.jsx(K,{index:y.SOURCE_DEPRECATED,currentIndex:o,children:e.jsx(je,{tabsMenuHeight:n})}),e.jsx(K,{index:y.SOURCES,currentIndex:o,children:e.jsx(je,{tabsMenuHeight:n})}),e.jsx(K,{index:y.EXTENSIONS,currentIndex:o,children:e.jsx(At,{tabsMenuHeight:n})}),e.jsx(K,{index:y.MIGRATE,currentIndex:o,children:e.jsx(Mt,{tabsMenuHeight:n})})]})}export{qs as Browse};
